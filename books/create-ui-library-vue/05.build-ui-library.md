---
title: 'Vueのコンポーネントをライブラリ化する'
---

前のページではデザイントークンをライブラリ(npm package)としてアプリケーションに組み込みました。ここでは共通化を行うレイヤーを上げて、Vueのアプリケーションに組み込む前提のUIライブラリを構築します。

## Viteのプロジェクトの作成 (第二陣)

第一陣ではアプリケーションのWebバンドラとしてViteを使いましたが、ここではUIライブラリのバンドラとしてViteを使います。
アプリケーションとライブラリでビルド時の設定も変わるので、 `vite.config.ts` の中身も比較しながらセットアップを進めていきましょう。

### design-tokensの修正

前のページではStyle DictionaryのBase Formatから提供されているトークンの一部だけ使いました。
`colors.json` にprimary / secondaryを移行します。

```json:packages/design-tokens/tokens/colors.json
{
  "colors": {
    "$type": "color",
    // ...
    "primary": {
      "DEFAULT": {
        "$value": "#0054e9"
      },
      "contrast": {
        "$value": "{colors.white}"
      },
      "shade": {
        "$value": "#004acd"
      },
      "tint": {
        "$value": "#1a65eb"
      }
    },
    "secondary": {
      "DEFAULT": {
        "$value": "#0163aa"
      },
      "contrast": {
        "$value": "{colors.white}"
      },
      "shade": {
        "$value": "#015796"
      },
      "tint": {
        "$value": "#1a73b3"
      }
    }
  }
}
```

追加した後ビルドできるか確認しておきましょう。

```zsh:zsh
  pnpm --filter design-tokens build
```

### monorepoの追加

`packages/` に追加でリポジトリを作成します。中でViteのボイラープレートを生成しましょう。
プロジェクト名は `ui` とし、テンプレートはアプリケーションと同じくVite + TypeScriptを選択します。
また、Tailwind CSSのセットアップも済ませておきましょう。

```zsh:zsh
  cd ./packages
  pnpm create vite@latest ui  --template vue-ts
  cd ./ui
  pnpm install
  pnpm add -D tailwindcss postcss autoprefixer @types/node
  pnpm tailwindcss init -p
  --- 以降のTailwind CSSのセットアップ手順は省略しますが、実施しましょう ---
```

後ほどトークンを使うので、以下の設定も行います。

`ui` の依存関係に `design-tokens` を追加して `pnpm install`

```diff json:packages/ui/package.json
 {
   "name": "ui",
   "private": true,
   "version": "0.0.0",
   "type": "module",
   "scripts": {
     "dev": "vite",
     "build": "vue-tsc -b && vite build",
     "preview": "vite preview"
   },
   "dependencies": {
+    "design-tokens": "workspace:*",
     "vue": "^3.5.13"
   },
   "devDependencies": {
     "@vitejs/plugin-vue": "^5.2.1",
     "@vue/tsconfig": "^0.7.0",
     "autoprefixer": "^10.4.20",
     "postcss": "^8.4.49",
     "tailwindcss": "^3.4.17",
     "typescript": "~5.6.2",
     "vite": "^6.0.5",
     "vue-tsc": "^2.2.0"
   }
 }
```

`tailwind.config.js` でもベタ書きしていたトークンをライブラリから引くようにしておきます。

```diff javascript:packages/ui/tailwind.config.js
import tokens from "design-tokens";

/** @type {import('tailwindcss').Config} */
export default {
  content: ["./index.html", "./src/**/*.{vue,js,ts,jsx,tsx}"],
  theme: {
    colors: {
      transparent: "transparent",
      current: "currentColor",
      black: tokens.colors.black,
      white: tokens.colors.white,
      primary: tokens.colors.primary,
      secondary: tokens.colors.secondary,
    },
    extend: {},
  },
  plugins: [],
};
```

### ライブラリから配布するコンポーネントを作る

`ButtonBase.vue` と同じ形で `ui/components` に `ChipBase.vue` を作ります。ライブラリの構築がゴールなので内容は簡易にしています。動作確認等は特に行わなくて大丈夫です。

```vue:packages/ui/components/ChipBase.vue
<script setup lang="ts"></script>

<template>
  <div
    class="bg-primary border-solid border-2 h-7 rounded-xl text-center text-primary-contrast w-32"
  >
    <span>
      <slot></slot>
    </span>
  </div>
</template>
```

次に `ui/src/main.ts` を丸っと書き換えます。これによりライブラリとして使う時に `import ChipBase from "ui"` `import {ChipBase} from "ui"` のようにimportすることができるようになります。

```typescript:packages/ui/src/main.ts
export * from "./components/ChipBase.vue";
export { default as ChipBase } from "./components/ChipBase.vue";
```

## Library Modeの設定

### Vite Library Modeについて

Viteのライブラリモードは、アプリケーションから使われるコンポーネントやユーティリティな関数等をライブラリとしてバンドルするための機能です。`index.html` をEntry pointとするアプリケーションバンドルとは異なり、 `main.js` `index.ts` のようなJavaScript(TypeScript)をEntry pointとし、複数の形式 (ESM/CJS/UMD) でライブラリをビルドすることができます。[^1]
[^1]: [Library Mode | Vite](https://vite.dev/guide/build#library-mode)

### Vue ComponentをVite Libraryでビルドする

`vite.config.ts` を書き換え、ライブラリをビルドできるようにしましょう。

```typescript:packages/ui/vite.config.ts
import vue from "@vitejs/plugin-vue";
import { resolve } from "path";
import { defineConfig } from "vite";

// https://vite.dev/config/
export default defineConfig({
  plugins: [vue()],
  build: {
    lib: {
      entry: resolve(__dirname, "src/main.ts"), // Entry pointとなるファイルを指定
      formats: ["es"], // FormatはESMに限定
    },
    rollupOptions: {
      external: ["vue"], // Vueをライブラリのバンドルに含めないようにする
    },
  },
});
```

設定したらビルドしましょう。 `packages/ui/dist` に `ui.js` が出力されます。

```zsh:zsh
  pnpm --filter ui build
```

### package.jsonの修正

`design-tokens` 同様、こちらも `package.json` を修正します。

```diff json:packages/ui/package.json
 {
   "name": "ui",
   "private": true,
   "version": "0.0.0",
   "type": "module",
+  "exports": "./dist/ui.js",
+  "module": "./dist/ui.js",
+  "files": [
+    "dist",
+    "tailwind.config.js"
+  ],
 # ...
```
